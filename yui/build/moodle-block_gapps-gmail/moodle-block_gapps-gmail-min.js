YUI.add("moodle-block_gapps-gmail",function(e,t){var n=function(){n.superclass.constructor.apply(this,arguments)};e.extend(n,e.Base,{initializer:function(){this.check_auth()},handle_reason:function(e){e instanceof Error},check_auth:function(){var e=this;this.get("gapi").auth.authorize({client_id:this.get("clientId"),scope:this.get("scopes"),immediate:!0},function(t){e.handle_auth_result(t)})},handle_auth_result:function(t){var n=e.all(".block_gapps .authorize");t&&!t.error?(n.setStyle("display","none"),this.fetch_messages(this.render_messages)):(t.error,n.on("click",this.handle_auth_click,this),n.setStyle("display","inline"))},handle_auth_click:function(e){e.preventDefault();var t=this;this.get("gapi").auth.authorize({client_id:this.get("clientId"),scope:this.get("scopes"),immediate:!1},function(e){t.handle_auth_result(e)})},fetch_messages:function(e){var t=this,n=[];this.get("gapi").client.load("gmail","v1").then(function(){return t.fetch_unread_messages()}).then(function(r){if(r.result.messages.length===0)throw e.call(t,0,[]),new Error("No unread messages returned");return n=r.result.messages,t.fetch_message_details_and_inbox(n)}).then(function(r){var i=t.process_message_details_and_inbox_responses(r,n);e.call(t,i.unreadMessagesCount,i.messages)}).then(undefined,function(e){t.handle_reason(e)})},fetch_unread_messages:function(){return this.get("gapi").client.gmail.users.messages.list({userId:"me",q:"is:unread",maxResults:this.get("numberOfMessages")})},fetch_message_details_and_inbox:function(e){var t=this.get("gapi").client.newHttpBatch();for(var n=0;n<e.length;n++){var r=this.get("gapi").client.gmail.users.messages.get({userId:"me",id:e[n].id,fields:"id,payload(headers),snippet"});t.add(r,{id:e[n].id})}var i=this.get("gapi").client.gmail.users.labels.get({userId:"me",id:"INBOX"});return t.add(i,{id:"INBOX"}),t},process_message_details_and_inbox_responses:function(e,t){var n=[];for(var r=0;r<t.length;r++){if(e.result[t[r].id]===undefined)continue;var i=e.result[t[r].id],s=this.get_from_names(this.find_header_value("From",i.result.payload.headers));n.push({id:i.result.id,subject:this.find_header_value("Subject",i.result.payload.headers),fromFirstName:s.firstName,fromLastName:s.lastName,snippet:i.result.snippet})}var o=e.result.INBOX!==undefined?e.result.INBOX.result.messagesUnread:0;return{unreadMessagesCount:o,messages:n}},render_messages:function(t,n){var r=e.one("#block_gapps-unread-messages-template").getHTML(),i=e.Handlebars.compile(r),s;s=i({unreadCount:t,messages:n}),e.all(".block_gapps .unreadmessages").setHTML(s)},get_from_names:function(e){var t=e.replace(/<.*>$/,"").trim(),n=t.split(" "),r="";n.length>1&&(r=n.pop());var i=n.join(" ");return{firstName:i,lastName:r}},find_header_value:function(e,t){for(var n=0;n<t.length;n++)if(e.toLowerCase()===t[n].name.toLowerCase())return t[n].value;return""}},{NAME:t,ATTRS:{gapi:{value:undefined},clientId:{validator:e.Lang.isString},scopes:{value:"https://www.googleapis.com/auth/gmail.readonly",readOnly:!0},numberOfMessages:{value:10,validator:e.Lang.isNumber}}}),M.block_gapps=M.block_gapps||{},M.block_gapps.Gmail=n},"@VERSION@",{requires:["base","event","handlebars"]});
